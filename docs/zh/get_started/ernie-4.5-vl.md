[English](../../get_started/ernie-4.5-vl.md)

# ERNIE-4.5-VLå¤šæ¨¡æ€æ¨¡å‹

æœ¬æ–‡æ¡£è®²è§£å¦‚ä½•éƒ¨ç½²ERNIE-4.5-VLå¤šæ¨¡æ€æ¨¡å‹ï¼Œæ”¯æŒç”¨æˆ·ä½¿ç”¨å¤šæ¨¡æ€æ•°æ®ä¸æ¨¡å‹è¿›è¡Œå¯¹è¯äº¤äº’(åŒ…å«æ€è€ƒReasoning)ï¼Œåœ¨å¼€å§‹éƒ¨ç½²å‰ï¼Œè¯·ç¡®ä¿ä½ çš„ç¡¬ä»¶ç¯å¢ƒæ»¡è¶³å¦‚ä¸‹æ¡ä»¶ï¼š

- GPUé©±åŠ¨ >= 535
- CUDA >= 12.3
- CUDNN >= 9.5
- Linux X86_64
- Python >= 3.10
- 80G A/H 8å¡

å®‰è£…FastDeployæ–¹å¼å‚è€ƒ[å®‰è£…æ–‡æ¡£](./installation/README.md)ã€‚

>ğŸ’¡ **æç¤º**ï¼š  ERNIEå¤šæ¨¡æ€ç³»åˆ—æ¨¡å‹å‡æ”¯æŒæ€è€ƒæ¨¡å¼ï¼Œå¯ä»¥é€šè¿‡åœ¨å‘èµ·æœåŠ¡è¯·æ±‚æ—¶è®¾ç½® ```enable_thinking``` å¼€å¯ï¼ˆå‚è€ƒå¦‚ä¸‹ç¤ºä¾‹ï¼‰ã€‚

## å‡†å¤‡æ¨¡å‹
éƒ¨ç½²æ—¶æŒ‡å®š```--model baidu/ERNIE-4.5-VL-424B-A47B-Paddle```å³å¯è‡ªåŠ¨ä»AIStudioä¸‹è½½æ¨¡å‹ï¼Œå¹¶æ”¯æŒæ–­ç‚¹ç»­ä¼ ã€‚ä½ ä¹Ÿå¯ä»¥è‡ªè¡Œä»ä¸åŒæ¸ é“ä¸‹è½½æ¨¡å‹ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯FastDeployä¾èµ–Paddleæ ¼å¼çš„æ¨¡å‹ï¼Œæ›´å¤šè¯´æ˜å‚è€ƒ[æ”¯æŒæ¨¡å‹åˆ—è¡¨](../supported_models.md)ã€‚

## å¯åŠ¨æœåŠ¡

æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ï¼Œå¯åŠ¨æœåŠ¡,å…¶ä¸­å¯åŠ¨å‘½ä»¤é…ç½®æ–¹å¼å‚è€ƒ[å‚æ•°è¯´æ˜](../parameters.md)

**æ³¨æ„**ï¼š ç”±äºæ¨¡å‹å‚æ•°é‡ä¸º424B-A47Bï¼Œåœ¨80G * 8å¡çš„æœºå™¨ä¸Šï¼Œéœ€æŒ‡å®š```--quantization wint4```(wint8ä¹Ÿå¯éƒ¨ç½²)ã€‚

```shell
export ENABLE_V1_KVCACHE_SCHEDULER=1
python -m fastdeploy.entrypoints.openai.api_server \
       --model baidu/ERNIE-4.5-VL-424B-A47B-Paddle \
       --port 8180 --engine-worker-queue-port 8181 \
       --cache-queue-port 8183 --metrics-port 8182 \
       --tensor-parallel-size 8 \
       --quantization wint4 \
       --max-model-len 32768 \
       --max-num-seqs 32 \
       --mm-processor-kwargs '{"video_max_frames": 30}' \
       --limit-mm-per-prompt '{"image": 10, "video": 3}' \
       --reasoning-parser ernie-45-vl
```

## ç”¨æˆ·å‘èµ·æœåŠ¡è¯·æ±‚
æ‰§è¡Œå¯åŠ¨æœåŠ¡æŒ‡ä»¤åï¼Œå½“ç»ˆç«¯æ‰“å°å¦‚ä¸‹ä¿¡æ¯ï¼Œè¯´æ˜æœåŠ¡å·²ç»å¯åŠ¨æˆåŠŸã€‚

```shell
api_server.py[line:91] Launching metrics service at http://0.0.0.0:8181/metrics
api_server.py[line:94] Launching chat completion service at http://0.0.0.0:8180/v1/chat/completions
api_server.py[line:97] Launching completion service at http://0.0.0.0:8180/v1/completions
INFO:     Started server process [13909]
INFO:     Waiting for application startup.
INFO:     Application startup complete.
INFO:     Uvicorn running on http://0.0.0.0:8180 (Press CTRL+C to quit)
```

FastDeployæä¾›æœåŠ¡æ¢æ´»æ¥å£ï¼Œç”¨ä»¥åˆ¤æ–­æœåŠ¡çš„å¯åŠ¨çŠ¶æ€ï¼Œæ‰§è¡Œå¦‚ä¸‹å‘½ä»¤è¿”å› ```HTTP/1.1 200 OK``` å³è¡¨ç¤ºæœåŠ¡å¯åŠ¨æˆåŠŸã€‚

```shell
curl -i http://0.0.0.0:8180/health
```

é€šè¿‡å¦‚ä¸‹å‘½ä»¤å‘èµ·æœåŠ¡è¯·æ±‚

```shell
curl -X POST "http://0.0.0.0:8180/v1/chat/completions" \
-H "Content-Type: application/json" \
-d '{
  "messages": [
    {"role": "user", "content": "æŠŠæç™½çš„é™å¤œæ€æ”¹å†™ä¸ºç°ä»£è¯—"}
  ]
}'
```
\
è¾“å…¥åŒ…å«å›¾ç‰‡æ—¶ï¼ŒæŒ‰å¦‚ä¸‹å‘½ä»¤å‘èµ·è¯·æ±‚

```shell
curl -X POST "http://0.0.0.0:8180/v1/chat/completions" \
-H "Content-Type: application/json" \
-d '{
  "messages": [
    {"role": "user", "content": [
      {"type":"image_url", "image_url": {"url":"https://paddlenlp.bj.bcebos.com/datasets/paddlemix/demo_images/example2.jpg"}},
      {"type":"text", "text":"å›¾ä¸­çš„æ–‡ç‰©å±äºå“ªä¸ªå¹´ä»£?"}
    ]}
  ]
}'
```
å›¾ç‰‡urlå­—æ®µåŒæ ·æ”¯æŒä¼ å…¥base64ç¼–ç å­—ç¬¦ä¸²:
```shell
{"type":"image_url", "image_url": {"url":"data:image/jpg;base64,this/is/an/example"}
```
æˆ–æœ¬åœ°æ–‡ä»¶çš„ç»å¯¹è·¯å¾„:
```shell
{"type":"image_url", "image_url": {"url":"file:///this/is/an/example"}
```
\
è¾“å…¥åŒ…å«è§†é¢‘æ—¶ï¼ŒæŒ‰å¦‚ä¸‹å‘½ä»¤å‘èµ·è¯·æ±‚

```shell
curl -X POST "http://0.0.0.0:8180/v1/chat/completions" \
-H "Content-Type: application/json" \
-d '{
  "messages": [
    {"role": "user", "content": [
      {"type":"video_url", "video_url": {"url":"https://bj.bcebos.com/v1/paddlenlp/datasets/paddlemix/demo_video/example_video.mp4"}},
      {"type":"text", "text":"ç”»é¢ä¸­æœ‰å‡ ä¸ªè‹¹æœ?"}
    ]}
  ]
}'
```
è§†é¢‘urlå­—æ®µåŒæ ·æ”¯æŒä¼ å…¥base64ç¼–ç å­—ç¬¦ä¸²:
```shell
{"type":"video_url", "video_url": {"url":"data:video/mp4;base64,this/is/an/example"}
```
æˆ–æœ¬åœ°æ–‡ä»¶çš„ç»å¯¹è·¯å¾„:
```shell
{"type":"video_url", "video_url": {"url":"file:///this/is/an/example"}
```
\
å½“å‰ERNIE-4.5-VLæ¨¡å‹æ”¯æŒæ€è€ƒæ¨¡å¼ä¸”é»˜è®¤å¼€å¯ï¼ŒæŒ‰å¦‚ä¸‹å‘½ä»¤å¯å…³é—­æ€è€ƒæ¨¡å¼

```shell
curl -X POST "http://0.0.0.0:8180/v1/chat/completions" \
-H "Content-Type: application/json" \
-d '{
  "messages": [
    {"role": "user", "content": [
      {"type": "image_url", "image_url": {"url": "https://paddlenlp.bj.bcebos.com/datasets/paddlemix/demo_images/example2.jpg"}},
      {"type": "text", "text": "å›¾ä¸­çš„æ–‡ç‰©å±äºå“ªä¸ªå¹´ä»£"}
    ]}
  ],
  "chat_template_kwargs":{"enable_thinking": false}
}'
```

FastDeployæœåŠ¡æ¥å£å…¼å®¹OpenAIåè®®ï¼Œå¯ä»¥é€šè¿‡å¦‚ä¸‹Pythonä»£ç å‘èµ·æœåŠ¡è¯·æ±‚, ä»¥ä¸‹ç¤ºä¾‹å¼€å¯æµå¼ç”¨æ³•ã€‚

```python
import openai
host = "0.0.0.0"
port = "8180"
client = openai.Client(base_url=f"http://{host}:{port}/v1", api_key="null")

response = client.chat.completions.create(
    model="null",
    messages=[
        {"role": "user", "content": [
            {"type": "image_url", "image_url": {"url": "https://paddlenlp.bj.bcebos.com/datasets/paddlemix/demo_images/example2.jpg"}},
            {"type": "text", "text": "å›¾ä¸­çš„æ–‡ç‰©å±äºå“ªä¸ªå¹´ä»£?"},
        ]},
    ],
    stream=True,
)
for chunk in response:
    if chunk.choices[0].delta:
        print(chunk.choices[0].delta.content, end='')
print('\n')
```

## æ¨¡å‹è¾“å‡º
åŒ…å«æ€è€ƒçš„è¾“å‡ºç¤ºä¾‹å¦‚ä¸‹, æ€è€ƒå†…å®¹åœ¨ `reasoning_content` å­—æ®µä¸­, æ¨¡å‹å›å¤å†…å®¹åœ¨ `content` å­—æ®µä¸­ã€‚

```json
{
    "id": "chatcmpl-c4772bea-1950-4bf4-b5f8-3d3c044aab06",
    "object": "chat.completion",
    "created": 1750236617,
    "model": "default",
    "choices": [
        {
            "index": 0,
            "message": {
                "role": "assistant",
                "content": "å›¾ä¸­çš„æ–‡ç‰©æ˜¯**å”ä»£ï¼ˆ7-8ä¸–çºªï¼‰çš„ä½›é™€ååƒ**ï¼Œç°è—äºä¸œäº¬å›½ç«‹åšç‰©é¦†ã€‚å…¶å¹´ä»£åˆ¤æ–­ä¾æ®å¦‚ä¸‹ï¼š\n\n1. **é€ å‹ç‰¹å¾**ï¼š\n   - ä½›é™€ç»“è·è¶ºåï¼ŒåŒæ‰‹ç»“ç¦…å®šå°ï¼Œèº«æŠ«é€šè‚©è¢ˆè£Ÿï¼Œè¡£çº¹å‘ˆé˜¶æ¢¯çŠ¶æ’åˆ—ï¼Œçº¿æ¡åšé‡ä¸”å¯Œæœ‰å±‚æ¬¡æ„Ÿï¼Œä½“ç°äº†å”ä»£ä½›åƒçš„å…¸å‹è¡£é¥°é£æ ¼ã€‚\n   - é¢éƒ¨åœ†æ¶¦ä¸°è…´ï¼ŒåŒç›®å¾®é—­ï¼Œå˜´è§’å«ç¬‘ï¼Œå±•ç°äº†å”ä»£ä½›åƒçš„æ…ˆæ‚²ç¥¥å’Œä¹‹æ€ï¼Œä¸åŒ—é­æ—¶æœŸçš„æ¸…ç˜¦é€ å‹å½¢æˆé²œæ˜å¯¹æ¯”ã€‚\n\n2. **èƒŒå…‰è®¾è®¡**ï¼š\n   - èƒŒå…‰å‘ˆèˆŸå½¢ï¼Œå†…å±‚é›•åˆ»å¯†é›†çš„åƒä½›ï¼ˆå°ä½›åƒï¼‰ï¼Œå¤–å±‚è£…é¥°ç«ç„°çº¹ï¼Œè¿™ç§ç¹å¤çš„èƒŒå…‰è®¾è®¡åœ¨å”ä»£å°¤ä¸ºç››è¡Œï¼Œè±¡å¾ä½›æ³•æ— è¾¹ã€‚\n\n3. **å·¥è‰ºä¸æè´¨**ï¼š\n   - çŸ³åƒè¡¨é¢æœ‰é£åŒ–ç—•è¿¹ï¼Œç¬¦åˆå”ä»£çŸ³é›•å†ç»åƒå¹´çš„è‡ªç„¶ä¾µèš€ç‰¹å¾ã€‚å”ä»£å¤šé‡‡ç”¨æ±‰ç™½ç‰ã€ç ‚å²©ç­‰æè´¨é›•åˆ»ä½›åƒï¼Œæ³¨é‡ç»†èŠ‚åˆ»ç”»ä¸æ•´ä½“æ°”åŠ¿ã€‚\n\n4. **å†å²èƒŒæ™¯**ï¼š\n   - å”ä»£æ˜¯ä¸­å›½ä½›æ•™å‘å±•çš„é¼ç››æ—¶æœŸï¼Œç»Ÿæ²»è€…æ¨å´‡ä½›æ•™ï¼Œå„åœ°å¼€çªŸé€ åƒä¹‹é£ç››è¡Œã€‚æ­¤åƒçš„åº„ä¸¥æ³•ç›¸ä¸ç››å”æ—¶æœŸâ€œä¸°è…´ä¸ºç¾â€çš„å®¡ç¾å–å‘é«˜åº¦å¥‘åˆã€‚\n\nç»¼ä¸Šï¼Œæ­¤åƒä»è‰ºæœ¯é£æ ¼åˆ°å·¥è‰ºç‰¹å¾å‡ç¬¦åˆå”ä»£ä½›æ•™é€ åƒçš„å…¸å‹ç‰¹ç‚¹ï¼Œæ˜¯ç ”ç©¶å”ä»£ä½›æ•™è‰ºæœ¯çš„é‡è¦å®ç‰©èµ„æ–™ã€‚",
                "reasoning_content": "ç”¨æˆ·é—®çš„æ˜¯å›¾ä¸­çš„æ–‡ç‰©å±äºå“ªä¸ªå¹´ä»£ã€‚é¦–å…ˆï¼Œæˆ‘éœ€è¦ç¡®å®šè¿™å¼ å›¾ç‰‡ä¸­çš„æ–‡ç‰©æ˜¯ä»€ä¹ˆã€‚çœ‹èµ·æ¥åƒæ˜¯ä¸€å°Šä½›åƒï¼Œå¯èƒ½æ˜¯ä¸­å›½çš„ä½›æ•™é€ åƒã€‚ä½›åƒçš„é€ å‹å’Œè£…é¥°é£æ ¼å¯èƒ½èƒ½å¸®åŠ©åˆ¤æ–­å¹´ä»£ã€‚\n\né¦–å…ˆï¼Œè§‚å¯Ÿä½›åƒçš„è¡£çº¹å’Œå§¿åŠ¿ã€‚è¿™å°Šä½›åƒç»“è·è¶ºåï¼ŒåŒæ‰‹æ”¾åœ¨è…¿ä¸Šï¼Œå¯èƒ½æ˜¯åœ¨ç¦…å®šå°ï¼Œè¿™æ˜¯æ¯”è¾ƒå¸¸è§çš„å§¿åŠ¿ã€‚ä½›åƒçš„è¡£çº¹æ¯”è¾ƒåšé‡ï¼Œæœ‰å±‚æ¬¡æ„Ÿï¼Œå¯èƒ½æ˜¯åŒ—é­æˆ–è€…éš‹å”æ—¶æœŸçš„é£æ ¼ã€‚åŒ—é­æ—¶æœŸçš„ä½›åƒé€šå¸¸æ¯”è¾ƒæ¸…ç˜¦ï¼Œè¡£çº¹çº¿æ¡ç¡¬æœ—ï¼Œè€Œéš‹å”æ—¶æœŸçš„ä½›åƒåˆ™æ›´ä¸°è…´ï¼Œè¡£çº¹æµç•…ã€‚\n\næ¥ä¸‹æ¥çœ‹èƒŒå…‰éƒ¨åˆ†ã€‚èƒŒå…‰ä¸Šæœ‰è®¸å¤šå°ä½›åƒï¼Œæ’åˆ—æˆåŒå¿ƒåœ†ï¼Œè¿™ç§è®¾è®¡åœ¨éš‹å”æ—¶æœŸæ¯”è¾ƒå¸¸è§ï¼Œå°¤å…¶æ˜¯å”ä»£ã€‚åŒ—é­æ—¶æœŸçš„èƒŒå…‰å¯èƒ½æ›´ç®€å•ï¼Œæˆ–è€…æœ‰é£å¤©ç­‰è£…é¥°ï¼Œä½†è¿™ç§å¯†é›†çš„å°ä½›åƒæ’åˆ—å¯èƒ½æ›´æ™šä¸€äº›ã€‚\n\nå¦å¤–ï¼Œä½›åƒçš„å¤´éƒ¨æœ‰èºå‘ï¼Œè‚‰é«»è¾ƒé«˜ï¼Œé¢éƒ¨åœ†æ¶¦ï¼Œè¿™äº›éƒ½æ˜¯å”ä»£ä½›åƒçš„ç‰¹ç‚¹ã€‚åŒ—é­çš„ä½›åƒé¢éƒ¨é€šå¸¸è¾ƒä¸ºæ¸…ç˜¦ï¼Œé¼»æ¢é«˜æŒºï¼Œè€Œå”ä»£çš„ä½›åƒé¢éƒ¨æ›´ä¸°æ»¡ï¼Œè¡¨æƒ…æ…ˆç¥¥ã€‚\n\nç»¼åˆè¿™äº›ç‰¹å¾ï¼Œè¿™å°Šä½›åƒå¯èƒ½å±äºå”ä»£ï¼Œå¤§çº¦7åˆ°8ä¸–çºªã€‚ä¸è¿‡ï¼Œä¹Ÿæœ‰å¯èƒ½å±äºåŒ—é­æ™šæœŸåˆ°éš‹ä»£ä¹‹é—´çš„è¿‡æ¸¡æ—¶æœŸï¼Œä½†ç»“åˆè¡£çº¹å’ŒèƒŒå…‰çš„è®¾è®¡ï¼Œå”ä»£çš„å¯èƒ½æ€§æ›´å¤§ã€‚éœ€è¦è¿›ä¸€æ­¥ç¡®è®¤æ˜¯å¦æœ‰å…¶ä»–ç‰¹å¾ï¼Œæ¯”å¦‚åº•åº§çš„æ ·å¼ã€é“­æ–‡ç­‰ï¼Œä½†å›¾ç‰‡ä¸­æ²¡æœ‰æ˜¾ç¤ºè¿™äº›ç»†èŠ‚ã€‚\n\nå¯èƒ½è¿˜éœ€è¦è€ƒè™‘æè´¨ï¼Œå¦‚æœæ˜¯çŸ³é›•ï¼Œå”ä»£å¸¸ç”¨æ±‰ç™½ç‰æˆ–ç ‚å²©ï¼Œè€ŒåŒ—é­å¯èƒ½æ›´å¤šä½¿ç”¨çŸ³ç°å²©ã€‚ä½†å›¾ç‰‡ä¸­çš„æè´¨çœ‹èµ·æ¥åƒæ˜¯é’é“œæˆ–é“è´¨ï¼Œä¸è¿‡ä¹Ÿæœ‰å¯èƒ½æ˜¯çŸ³é›•ç»è¿‡é£åŒ–åçš„é¢œè‰²ã€‚ä¸è¿‡ï¼Œä½›åƒçš„é‡‘å±è´¨æ„Ÿå¯èƒ½æ›´æ¥è¿‘å”ä»£ï¼Œå°¤å…¶æ˜¯å¦‚æœè¡¨é¢æœ‰éé‡‘çš„è¯ï¼Œä½†è¿™é‡Œçœ‹èµ·æ¥æœ‰äº›æ°§åŒ–ï¼Œå¯èƒ½ä¸ºé“œè´¨ã€‚\n\næ€»ä¹‹ï¼Œç»“åˆé€ å‹ã€è¡£çº¹ã€èƒŒå…‰å’Œé¢éƒ¨ç‰¹å¾ï¼Œè¿™å°Šä½›åƒå¾ˆå¯èƒ½å±äºä¸­å›½å”ä»£çš„ä½›æ•™é€ åƒï¼Œå¤§çº¦7è‡³8ä¸–çºªã€‚"
            },
            "finish_reason": "stop"
        }
    ],
    "usage": {
        "prompt_tokens": 1260,
        "total_tokens": 2042,
        "completion_tokens": 782,
        "prompt_tokens_details": {
            "cached_tokens": 0
        }
    }
}
```

ä¸åŒ…å«æ€è€ƒçš„è¾“å‡ºç¤ºä¾‹å¦‚ä¸‹, æ¨¡å‹å›å¤å†…å®¹åœ¨ `content` å­—æ®µä¸­ã€‚

```python

{
    "id": "chatcmpl-4d508b96-0ea1-4430-98a6-ae569f74f25b",
    "object": "chat.completion",
    "created": 1750236495,
    "model": "default",
    "choices": [
        {
            "index": 0,
            "message": {
                "role": "assistant",
                "content": "å›¾ä¸­çš„æ–‡ç‰©æ˜¯**åŒ—é­å¤ªå’Œå…ƒå¹´ï¼ˆ477å¹´ï¼‰é‡Šè¿¦ç‰Ÿå°¼ä½›åƒ**ï¼Œç°æ”¶è—äºæ•…å®«åšç‰©é™¢ã€‚è¿™å°Šä½›åƒå…·æœ‰æ˜¾è‘—çš„åŒ—é­ä½›åƒè‰ºæœ¯ç‰¹å¾ï¼Œå…¶å¹´ä»£æ˜ç¡®ï¼Œé¢˜è®°ä¸­è®°è½½äº†â€œå¤ªå’Œå…ƒå¹´â€çš„çºªå¹´ï¼Œå³åŒ—é­å­æ–‡å¸å…ƒå®çš„å¹´å·ã€‚åŒ—é­æ—¶æœŸï¼ˆ386-534å¹´ï¼‰æ˜¯ä½›æ•™è‰ºæœ¯åœ¨ä¸­å›½å‘å±•çš„é‡è¦é˜¶æ®µï¼Œä½›åƒé€ å‹é€æ¸ä»å¤–æ¥é£æ ¼è½¬å‘æœ¬åœŸåŒ–ï¼Œæ­¤åƒæ­£æ˜¯è¿™ä¸€è½¬å˜çš„å…¸å‹ä»£è¡¨ã€‚å…¶è¡£çº¹æµç•…ã€é¢ç›¸æ…ˆç¥¥ï¼ŒèƒŒå…‰é›•åˆ»ç²¾ç¾ï¼Œå±•ç°äº†åŒ—é­ä¸­æ™šæœŸä½›åƒè‰ºæœ¯çš„æˆç†Ÿä¸ç‹¬ç‰¹åŠ›ã€‚",
                "reasoning_content": null
            },
            "finish_reason": "stop"
        }
    ],
    "usage": {
        "prompt_tokens": 1265,
        "total_tokens": 1407,
        "completion_tokens": 142,
        "prompt_tokens_details": {
            "cached_tokens": 0
        }
    }
}
```
